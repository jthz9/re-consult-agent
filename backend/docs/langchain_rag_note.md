# RAG (Retrieval-Augmented Generation) 시스템 기술 문서

## 1. 시스템 개요

### 1.1 RAG의 목적

- 문서/데이터베이스에서 정보 검색
- 허위 정보나 환각(hallucination) 방지
- 출처가 명확한 정보 제공
- 컨텍스트 기반 답변

### 1.2 시스템 목적

- 재생에너지 관련 FAQ 데이터를 기반으로 한 지식 기반 질의응답 시스템
- 사용자 질문에 대한 정확하고 전문적인 답변 제공

### 1.2 주요 기능

- 문서 로드 및 벡터화
- 의미 기반 문서 검색
- 컨텍스트 기반 답변 생성

## 2. 기술 스택

### 2.1 핵심 컴포넌트

- **LLM**: GPT-4o (OpenAI)
- **임베딩 모델**: snunlp/KR-SBERT-V40K-klueNLI-augSTS
- **벡터 저장소**: Chroma
- **프레임워크**: LangChain

### 2.2 주요 라이브러리

- langchain_openai: OpenAI 모델 통합
- langchain_community: 커뮤니티 컴포넌트
- chromadb: 벡터 데이터베이스
- sentence-transformers: 임베딩 모델

## 3. 시스템 아키텍처

### 3.1 주요 컴포넌트

1. **문서 로더 (DocumentLoader)**

   - 다양한 형식의 문서 로드
   - 메타데이터 처리
   - 문서 전처리

2. **텍스트 분할기 (TextSplitter)**

   - 문서 청크 분할
   - 오버랩 설정
   - 컨텍스트 유지

3. **임베딩 모델 (EmbeddingModel)**

   - 한국어 특화 임베딩
   - 문장 수준 임베딩
   - 의미적 유사도 계산

4. **벡터 저장소 (VectorStore)**

   - 문서 벡터 저장
   - 효율적인 검색
   - 지속성 관리

5. **검색기 (Retriever)**

   - 의미 기반 검색
   - MMR 알고리즘
   - 점수 기반 필터링

6. **RAG 파이프라인**
   - 컴포넌트 통합
   - 검색 및 생성 프로세스 관리
   - 결과 포맷팅

## 4. 검색 정확도 최적화

### 4.1 검색 파라미터

```python
search_kwargs = {
    "k": 5,              # 최종 반환 문서 수
    "score_threshold": 0.5,  # 유사도 점수 임계값
    "fetch_k": 20,       # 초기 검색 문서 수
    "lambda_mult": 0.7   # MMR 다양성 파라미터
}
```

### 4.2 파라미터 설명

1. **k (최종 반환 문서 수)**

   - 최종적으로 사용자에게 반환할 문서의 수
   - 3-7개 사이가 적절
   - 현재 5개로 설정

2. **score_threshold (유사도 점수 임계값)**

   - 문서의 유사도 점수 임계값
   - 0.0 ~ 1.0 사이의 값
   - 현재 0.5로 설정

3. **fetch_k (초기 검색 문서 수)**

   - MMR 알고리즘의 초기 검색 문서 수
   - 현재 20개로 설정
   - 더 많은 문서를 고려하여 다양성 확보

4. **lambda_mult (MMR 다양성 파라미터)**
   - 유사도와 다양성의 균형 조절
   - 0.0 ~ 1.0 사이의 값
   - 현재 0.7로 설정 (균형 잡힌 접근)

### 4.3 MMR 알고리즘

- 최대 한계 관련성(Maximal Marginal Relevance) 알고리즘 사용
- 유사도와 다양성의 균형 고려
- 중복 정보 최소화
- 다양한 관점의 정보 제공

## 5. 프롬프트 엔지니어링

### 5.1 RAG 프롬프트 설계 원칙

1. **컨텍스트 중심**

   - 검색된 문서의 정보만을 사용
   - 컨텍스트 기반의 인용 강조
   - 정보 부족 시 명확한 응답

2. **정확성 강화**

   - 정보 왜곡 방지
   - 과장하지 않도록 지시
   - 컨텍스트의 정확한 반영

3. **투명성**
   - 컨텍스트의 정보를 인용하여 설명
   - 정보의 출처를 명확히 함
   - 불확실성에 대한 명확한 처리

### 5.2 프롬프트 구조

```python
prompt_template = """
주어진 컨텍스트를 바탕으로 질문에 답변해주세요. 컨텍스트에 있는 정보만을 사용하여 답변하세요.

[컨텍스트]
{context}

[질문]
{question}

[답변 형식]
1. 핵심 답변: 컨텍스트에 있는 정보를 바탕으로 한 직접적인 답변
2. 상세 설명: 컨텍스트에서 관련된 정보를 인용하여 자세히 설명
3. 참고 사항: 컨텍스트에서 확인된 추가 정보나 주의사항

[주의사항]
- 컨텍스트에 있는 정보만을 사용하여 답변하세요
- 컨텍스트에 없는 정보는 생성하지 마세요
- 컨텍스트의 정보가 부족한 경우, "제공된 컨텍스트에 해당 정보가 없습니다"라고 답변하세요
- 답변은 항상 한국어로 작성하세요
- 컨텍스트의 정보를 왜곡하거나 과장하지 마세요

답변:"""
```

### 5.3 프롬프트 전략

1. **컨텍스트 활용**

   - 검색된 문서의 정보만 사용
   - 컨텍스트 기반 인용
   - 정보 부족 시 명확한 응답

2. **구조화된 답변**

   - 핵심 답변
   - 상세 설명 (인용 포함)
   - 참고 사항

3. **명확한 지침**

   - 컨텍스트 제한
   - 정보 왜곡 방지
   - 불확실성 처리

4. **언어 및 스타일**
   - 한국어 사용
   - 명확하고 객관적인 설명
   - 일관된 톤 유지

## 6. 성능 개선

### 6.1 검색 성능

- 의미 기반 검색으로 정확도 향상
- MMR 알고리즘으로 다양성 확보
- 점수 기반 필터링으로 품질 관리

### 6.2 생성 성능

- 구조화된 프롬프트로 일관된 답변
- 전문가 역할 부여로 품질 향상
- 컨텍스트와 전문 지식의 균형
